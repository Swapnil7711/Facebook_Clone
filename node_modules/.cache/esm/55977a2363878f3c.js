let multer,path,fs,CustomeErrorHandler,Post;_638‍.x([["postController",()=>postController],["default",()=>_638‍.o]]);_638‍.w("multer",[["default",["multer"],function(v){multer=v}]]);_638‍.w("path",[["default",["path"],function(v){path=v}]]);_638‍.w("fs",[["default",["fs"],function(v){fs=v}]]);_638‍.w("../services/CustomErrorHandler",[["default",["CustomeErrorHandler"],function(v){CustomeErrorHandler=v}]]);_638‍.w("../models/Posts",[["default",["Post"],function(v){Post=v}]]);







const storage = multer.diskStorage({
    destination: (req, file, cb) => cb(null, 'uploads'),
    filename: (req, file, cb) => {
        const uniqueName = `${Date.now()}-${Math.round(Math.random() * 1E9)}${path.extname(file.originalname)}`
        cb(null, uniqueName);
    }
});

const handlePostImages = multer({ storage, limits: { fileSize: 1000000 * 5 } }).single('postImage')


       const postController = {

    async createPost(req, res, next) {

        // validate the post request. it is importatnt to validate request before creating post to avoid error.

        handlePostImages(req, res, async (err) => {

            if (err) {
                return next(CustomeErrorHandler.serverError(err.message))
            }

            const filepath = req.file && req.file.path

            const post = new Post({
                postText: req.body.postText,
                postImage: filepath,
                user: req.body.userId
            })
            let result;
            try {

                // result = await post.save()

                result = await Post.create({
                    postText: req.body.postText,
                    postImage: filepath,
                    user: req.body.userId
                })
                _638‍.g.console.log(result)

            } catch (error) {
                return next(CustomeErrorHandler.serverError())
            }

            const userPost = await Post.findById(result._id).then(doc => (doc.populate('user', 'first_name last_name profile').execPopulate()))

            res.json(userPost)

        })
    },


    async getPosts(req, res, next) {

        try {
            //  to find the reverse order add date field
            // const posts = await Post.find().then(doc => (doc.populate('user', 'first_name last_name profile').execPopulate()))

            let posts = await Post.find().populate('user', 'first_name last_name profile').select('-id')

            posts = posts.reverse()

            res.json(posts);
        } catch (error) {
            return res.json(error.message)
        }

    }
}

_638‍.d(postController);

